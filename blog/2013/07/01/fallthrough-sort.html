<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Fallthrough Sort: Quickly Sorting Small Sets</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="The musings and work of Ryan Marcus, a graduate student at the Los Alamos National Laboratory.">
    <link rel="canonical" href="/blog/2013/07/01/fallthrough-sort.html">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/blog/css/main.css">
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
      tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]}
      });
    </script>
    <script type="text/javascript"
	    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>

</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/">RMarcus.info</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          <a class="page-link" href="/blog/pubs/">Publications</a>
        
          <a class="page-link" href="/blog/feed.xml"></a>
        
          <a class="page-link" href="/blog/index.html"></a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Fallthrough Sort: Quickly Sorting Small Sets</h1>
    <p class="meta">Jul 1, 2013</p>
  </header>

  <article class="post-content">
  <p>In many applications, such as a <a href="http://en.wikipedia.org/wiki/Median_filter">median filter</a>, we want to sort a small ([latex]n &lt; 30[/latex]) set of numbers. In the case of the median filter, we are only concerned with sorting sets of one exact size â€“ if this is the case, one can generate an optimal <a href="http://en.wikipedia.org/wiki/Sorting_network">sorting network</a> using a tool like <a href="http://pages.ripco.net/~jgamble/nw.html">this one</a> to create a provably-unbeatable solution.</p>

<p>However, often we want to be able to sort sets of varying size that are still small. Perhaps if one wished to implement a 3x3, 5x5, and 7x7 median filter using a single sorting function. Or perhaps when sorting an arbitrary list of files, when there could be very many or very few items.</p>

<p>In this case, we can utilize a special implementation of <a href="http://en.wikipedia.org/wiki/Bubble_sort">bubble sort</a> that takes advantage of <a href="http://en.wikipedia.org/wiki/Switch_statement#Fallthrough">switch statement fallthrough</a>. To quickly sort sets of size [latex]n \leq 9[/latex], we could use this C code:</p>

<div class="highlight"><pre><code class="c"><span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#define min(a, b) (a &lt; b ? a : b)</span>
<span class="cp">#define max(a, b) (a &gt; b ? a : b)</span>
<span class="cp">#define exch(a, b) temp = a; a = min(temp, b); b = max(temp, b);</span>
<span class="cp">#define exch3(a, b, c) exch(a, b); exch(b, c);</span>
<span class="cp">#define exch4(a,b,c,d) exch3(a,b,c); exch(c,d);</span>
<span class="cp">#define exch5(a,b,c,d,e) exch4(a,b,c,d); exch(d,e);</span>
<span class="cp">#define exch6(a,b,c,d,e,f) exch5(a,b,c,d,e); exch(e,f);</span>
<span class="cp">#define exch7(a,b,c,d,e,f,g) exch6(a,b,c,d,e,f); exch(f,g);</span>
<span class="cp">#define exch8(a,b,c,d,e,f,g,h) exch7(a,b,c,d,e,f,g); exch(g,h);</span>
<span class="cp">#define exch9(a,b,c,d,e,f,g,h,i) exch8(a,b,c,d,e,f,g,h); exch(h,i);</span>



<span class="kt">int</span> <span class="nf">cmpfunc</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">a</span> <span class="o">-</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">b</span> <span class="p">);</span>
<span class="p">}</span>
<span class="c1">// quickly sort an array if size is less than or equal to 9, otherwise use</span>
<span class="c1">// stdlib&#39;s qsort to sort the array.</span>
<span class="kt">void</span> <span class="nf">fallthroughSort</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">array</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">9</span>:
     	<span class="n">exch9</span><span class="p">(</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
		       <span class="n">array</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="p">);</span>
    <span class="k">case</span> <span class="mi">8</span>:
     	<span class="n">exch8</span><span class="p">(</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
		       <span class="n">array</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="p">);</span>
    <span class="k">case</span> <span class="mi">7</span>:
     	<span class="n">exch7</span><span class="p">(</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
		       <span class="n">array</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="p">);</span>
    <span class="k">case</span> <span class="mi">6</span>:
     	<span class="n">exch6</span><span class="p">(</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
		       <span class="n">array</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="p">);</span>
    <span class="k">case</span> <span class="mi">5</span>:
     	<span class="n">exch5</span><span class="p">(</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="p">);</span>
    <span class="k">case</span> <span class="mi">4</span>:
     	<span class="n">exch4</span><span class="p">(</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">);</span>
    <span class="k">case</span> <span class="mi">3</span>:
     	<span class="n">exch3</span><span class="p">(</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">);</span>
    <span class="k">case</span> <span class="mi">2</span>:
     	<span class="n">exch</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
     	<span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
     	<span class="n">qsort</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="n">cmpfunc</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>Each call to [latex]exchN[/latex] represents a bubble sort pass from index [latex]0[/latex] to index [latex]N[/latex]. Any array that is of size [latex]n \leq 9[/latex] will jump to the proper pass of bubble sort, and execute all the required passes by falling through the switch statement.</p>

<p>You might be skeptical as to how a [latex]O(n^2)[/latex] algorithm is outperforming a [latex]O(n \log n)[/latex] algorithm, but remember that big-O notation only defines asymptotic behavior. It is often the case that the actual performance of an algorithm depends on the constants hidden by big-O notation, as has been <a href="http://stackoverflow.com/questions/7643377/why-is-insertion-sort-faster-than-quick-sort-and-bubble-sort-for-small-cases">exhaustively discussed</a>.</p>

<p>Of course, code similar to that above can be generated for any size, and a Python script to do just that is available in this <a href="https://bitbucket.org/RyanMarcus/fallthrough-sort">BitBucket repository</a>. Weâ€™ll take a look at the performance of this algorithm.</p>

<p>The following graph shows the performance of fallthrough sort (for [latex]n \leq 9[/latex]) compared to the standard libraryâ€™s qsort function. Both functions sorted [latex]10^7[/latex] randomly generated lists of size [latex]n = 9[/latex].</p>

<center>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/static/modules/gviz/1.0/chart.js"> {"dataSourceUrl":"//docs.google.com/a/rmarcus.info/spreadsheet/tq?key=0AmQWGSF3o-iidFlYX1lOWUtVNENMM0lCa05Tbi1VZUE&transpose=0&headers=1&range=A53%3AC61&gid=0&pub=1","options":{"titleTextStyle":{"bold":true,"color":"#000","fontSize":16},"series":{"0":{"hasAnnotations":true}},"curveType":"function","animation":{"duration":500},"lineWidth":2,"hAxis":{"title":"Arrays sorted","useFormatFromData":true,"minValue":null,"viewWindow":{"min":null,"max":null},"maxValue":null},"vAxes":[{"title":"Time (s)","useFormatFromData":true,"minValue":null,"viewWindow":{"min":null,"max":null},"logScale":false,"maxValue":null},{"useFormatFromData":true,"minValue":null,"viewWindow":{"min":null,"max":null},"logScale":false,"maxValue":null}],"title":"n=9 Quicksort vs. Fallthrough Sort","booleanRole":"certainty","legend":"right","annotations":{"domain":{}},"useFirstColumnAsDomain":true,"tooltip":{},"width":451,"height":320},"state":{},"view":{},"isDefaultVisualization":true,"chartType":"LineChart","chartName":"Chart 1"} </script>
</center>
<p>As you can see, fallthrough sort provides a substantial speed boost. Obviously, the difference is negligible if youâ€™re only sorting one list.</p>

<p>This next graph shows the performance of fallthrough sort (for [latex]n \leq 25[/latex]) compared to the standard libraryâ€™s qsort function when sorting [latex]10^7[/latex] lists of varying sizes.</p>

<center>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/static/modules/gviz/1.0/chart.js"> {"dataSourceUrl":"//docs.google.com/a/rmarcus.info/spreadsheet/tq?key=0AmQWGSF3o-iidFlYX1lOWUtVNENMM0lCa05Tbi1VZUE&transpose=0&headers=1&range=A1%3AC24&gid=0&pub=1","options":{"vAxes":[{"useFormatFromData":true,"title":"Time (s)","minValue":null,"logScale":false,"viewWindow":{"min":null,"max":null},"maxValue":null},{"useFormatFromData":true,"minValue":null,"logScale":false,"viewWindow":{"min":null,"max":null},"maxValue":null}],"titleTextStyle":{"bold":true,"color":"#000","fontSize":16},"booleanRole":"certainty","curveType":"function","title":"10^7 Quicksort vs. Fallthrough Sort","animation":{"duration":500},"legend":"right","lineWidth":2,"useFirstColumnAsDomain":true,"hAxis":{"useFormatFromData":true,"title":"# of elements","minValue":null,"viewWindow":{"min":null,"max":null},"maxValue":null},"tooltip":{},"width":450,"height":320},"state":{},"view":{},"isDefaultVisualization":true,"chartType":"LineChart","chartName":"Chart 2"} </script>
</center>

<p>As the number of elements increases, fallthrough sort seems to slow down and approach the speed of qsort (eventually, qsort will become faster). This is expected, given the asymptotic behavior of each algorithm.</p>

<p>This last graph shows how many times faster fallthrough sort is compared to qsort.</p>

<center>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/static/modules/gviz/1.0/chart.js"> {"dataSourceUrl":"//docs.google.com/a/rmarcus.info/spreadsheet/tq?key=0AmQWGSF3o-iidFlYX1lOWUtVNENMM0lCa05Tbi1VZUE&transpose=0&headers=1&range=A26%3AB49&gid=0&pub=1","options":{"vAxes":[{"useFormatFromData":true,"title":"Times faster","minValue":null,"viewWindow":{"min":null,"max":null},"maxValue":null},{"useFormatFromData":true,"minValue":null,"viewWindow":{"min":null,"max":null},"maxValue":null}],"titleTextStyle":{"bold":true,"color":"#000","fontSize":16},"booleanRole":"certainty","curveType":"function","title":"Fallthrough Sort Speed Multiplier","animation":{"duration":500},"legend":"right","lineWidth":2,"useFirstColumnAsDomain":true,"hAxis":{"title":"# of elements","useFormatFromData":true,"minValue":null,"viewWindow":{"min":null,"max":null},"maxValue":null},"tooltip":{},"width":450,"height":320},"state":{},"view":{},"isDefaultVisualization":true,"chartType":"LineChart","chartName":"Chart 3"} </script>
</center>

<p>Here, the asymptotic behavior of both algorithms is extremely clear: qsort scales much better than fallthrough sort.</p>

<p>One might consider this comparison unfair because qsort evaluates a user-supplied comparison function. However, looking at the output of GCC reveals that when a very standard function (like the one above) is used, the comparison function is inlined.</p>

<p>One might also consider creating a <a href="http://en.wikipedia.org/wiki/Branch_table">branch table</a> to jump right to the required pass of bubble sort. Once again, looking at optimized GCC output will show that the above switch statement is optimized into a branch table.</p>

<p>You can view a sample implementation and benchmark code over at <a href="https://bitbucket.org/RyanMarcus/fallthrough-sort">BitBucket</a>.</p>

<p><a href="https://plus.google.com/u/0/108417296717615529338/posts/45VYfwK5mjU">Google+ comments</a>.</p>

<p><a href="http://www.reddit.com/r/programming/comments/1hilkn/fallthrough_sort_quickly_sorting_small_sets/">Reddit comments</a>.</p>

<p>Reddit user <a href="http://www.reddit.com/r/programming/comments/1hilkn/fallthrough_sort_quickly_sorting_small_sets/cauvhhp">sltkr seems to be getting better results from a simple insertion sort</a>. This appears to be due to CPU differences, but the discussion is ongoing.</p>


  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">RMarcus.info</h2>

    <div class="footer-col-1 column">
      <ul>
        <li>It's all Frank's Fault</li>
        <li><a href="mailto:ryan@rmarcus.info">ryan@rmarcus.info</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username"></span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username"></span>
          </a>
        </li>
      </ul>
    </div>

    <div class="footer-col-3 column">
      <p class="text">The musings and work of Ryan Marcus, a graduate student at the Los Alamos National Laboratory.</p>
    </div>

  </div>

</footer>


    </body>
</html>