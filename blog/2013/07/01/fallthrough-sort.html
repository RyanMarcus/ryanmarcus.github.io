<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Fallthrough Sort: Quickly Sorting Small Sets &middot; RMarcus
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/blog/public/css/poole.css">
  <link rel="stylesheet" href="/blog/public/css/syntax.css">
  <link rel="stylesheet" href="/blog/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/blog/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/blog/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/blog/atom.xml">

  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    tex2jax: {
    inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']],
    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
    }
    });
  </script>
  <script type="text/javascript"
	  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>RMarcus</h1>
      <p class="lead">The musings and work of Ryan Marcus, a graduate student at the Los Alamos National Laboratory.</p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
        <a href="/">Home</a>
      </li>

      

      
      
        
          
        
      
        
          
            <li class="sidebar-nav-item">
              <a href="/blog/pubs/">Portfolio</a>
            </li>
          
        
      
        
      
        
      
        
          
        
      


      <!-- <li class="sidebar-nav-item"><a href="/archive/v2.0.0.zip">Download</a></li>
      <li class="sidebar-nav-item"><a href="">GitHub project</a></li>
      <li class="sidebar-nav-item">Currently v2.0.0</li> -->
    </ul>

    <p>&copy; 2014. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Fallthrough Sort: Quickly Sorting Small Sets</h1>
  <span class="post-date">01 Jul 2013</span>
  <p>In many applications, such as a <a href="http://en.wikipedia.org/wiki/Median_filter">median filter</a>, we want to sort a small ([latex]n &lt; 30[/latex]) set of numbers. In the case of the median filter, we are only concerned with sorting sets of one exact size – if this is the case, one can generate an optimal <a href="http://en.wikipedia.org/wiki/Sorting_network">sorting network</a> using a tool like <a href="http://pages.ripco.net/~jgamble/nw.html">this one</a> to create a provably-unbeatable solution.</p>

<p>However, often we want to be able to sort sets of varying size that are still small. Perhaps if one wished to implement a 3x3, 5x5, and 7x7 median filter using a single sorting function. Or perhaps when sorting an arbitrary list of files, when there could be very many or very few items.</p>

<p>In this case, we can utilize a special implementation of <a href="http://en.wikipedia.org/wiki/Bubble_sort">bubble sort</a> that takes advantage of <a href="http://en.wikipedia.org/wiki/Switch_statement#Fallthrough">switch statement fallthrough</a>. To quickly sort sets of size [latex]n \leq 9[/latex], we could use this C code:</p>

<div class="highlight"><pre><code class="c"><span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#define min(a, b) (a &lt; b ? a : b)</span>
<span class="cp">#define max(a, b) (a &gt; b ? a : b)</span>
<span class="cp">#define exch(a, b) temp = a; a = min(temp, b); b = max(temp, b);</span>
<span class="cp">#define exch3(a, b, c) exch(a, b); exch(b, c);</span>
<span class="cp">#define exch4(a,b,c,d) exch3(a,b,c); exch(c,d);</span>
<span class="cp">#define exch5(a,b,c,d,e) exch4(a,b,c,d); exch(d,e);</span>
<span class="cp">#define exch6(a,b,c,d,e,f) exch5(a,b,c,d,e); exch(e,f);</span>
<span class="cp">#define exch7(a,b,c,d,e,f,g) exch6(a,b,c,d,e,f); exch(f,g);</span>
<span class="cp">#define exch8(a,b,c,d,e,f,g,h) exch7(a,b,c,d,e,f,g); exch(g,h);</span>
<span class="cp">#define exch9(a,b,c,d,e,f,g,h,i) exch8(a,b,c,d,e,f,g,h); exch(h,i);</span>



<span class="kt">int</span> <span class="nf">cmpfunc</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">a</span> <span class="o">-</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">b</span> <span class="p">);</span>
<span class="p">}</span>
<span class="c1">// quickly sort an array if size is less than or equal to 9, otherwise use</span>
<span class="c1">// stdlib&#39;s qsort to sort the array.</span>
<span class="kt">void</span> <span class="nf">fallthroughSort</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">array</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">9</span>:
     	<span class="n">exch9</span><span class="p">(</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
		       <span class="n">array</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="p">);</span>
    <span class="k">case</span> <span class="mi">8</span>:
     	<span class="n">exch8</span><span class="p">(</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
		       <span class="n">array</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="p">);</span>
    <span class="k">case</span> <span class="mi">7</span>:
     	<span class="n">exch7</span><span class="p">(</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
		       <span class="n">array</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="p">);</span>
    <span class="k">case</span> <span class="mi">6</span>:
     	<span class="n">exch6</span><span class="p">(</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
		       <span class="n">array</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="p">);</span>
    <span class="k">case</span> <span class="mi">5</span>:
     	<span class="n">exch5</span><span class="p">(</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="p">);</span>
    <span class="k">case</span> <span class="mi">4</span>:
     	<span class="n">exch4</span><span class="p">(</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">);</span>
    <span class="k">case</span> <span class="mi">3</span>:
     	<span class="n">exch3</span><span class="p">(</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">);</span>
    <span class="k">case</span> <span class="mi">2</span>:
     	<span class="n">exch</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
     	<span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
     	<span class="n">qsort</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="n">cmpfunc</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>Each call to [latex]exchN[/latex] represents a bubble sort pass from index [latex]0[/latex] to index [latex]N[/latex]. Any array that is of size [latex]n \leq 9[/latex] will jump to the proper pass of bubble sort, and execute all the required passes by falling through the switch statement.</p>

<p>You might be skeptical as to how a [latex]O(n^2)[/latex] algorithm is outperforming a [latex]O(n \log n)[/latex] algorithm, but remember that big-O notation only defines asymptotic behavior. It is often the case that the actual performance of an algorithm depends on the constants hidden by big-O notation, as has been <a href="http://stackoverflow.com/questions/7643377/why-is-insertion-sort-faster-than-quick-sort-and-bubble-sort-for-small-cases">exhaustively discussed</a>.</p>

<p>Of course, code similar to that above can be generated for any size, and a Python script to do just that is available in this <a href="https://bitbucket.org/RyanMarcus/fallthrough-sort">BitBucket repository</a>. We’ll take a look at the performance of this algorithm.</p>

<p>The following graph shows the performance of fallthrough sort (for [latex]n \leq 9[/latex]) compared to the standard library’s qsort function. Both functions sorted [latex]10^7[/latex] randomly generated lists of size [latex]n = 9[/latex].</p>

<center>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/static/modules/gviz/1.0/chart.js"> {"dataSourceUrl":"//docs.google.com/a/rmarcus.info/spreadsheet/tq?key=0AmQWGSF3o-iidFlYX1lOWUtVNENMM0lCa05Tbi1VZUE&transpose=0&headers=1&range=A53%3AC61&gid=0&pub=1","options":{"titleTextStyle":{"bold":true,"color":"#000","fontSize":16},"series":{"0":{"hasAnnotations":true}},"curveType":"function","animation":{"duration":500},"lineWidth":2,"hAxis":{"title":"Arrays sorted","useFormatFromData":true,"minValue":null,"viewWindow":{"min":null,"max":null},"maxValue":null},"vAxes":[{"title":"Time (s)","useFormatFromData":true,"minValue":null,"viewWindow":{"min":null,"max":null},"logScale":false,"maxValue":null},{"useFormatFromData":true,"minValue":null,"viewWindow":{"min":null,"max":null},"logScale":false,"maxValue":null}],"title":"n=9 Quicksort vs. Fallthrough Sort","booleanRole":"certainty","legend":"right","annotations":{"domain":{}},"useFirstColumnAsDomain":true,"tooltip":{},"width":451,"height":320},"state":{},"view":{},"isDefaultVisualization":true,"chartType":"LineChart","chartName":"Chart 1"} </script>
</center>
<p>As you can see, fallthrough sort provides a substantial speed boost. Obviously, the difference is negligible if you’re only sorting one list.</p>

<p>This next graph shows the performance of fallthrough sort (for [latex]n \leq 25[/latex]) compared to the standard library’s qsort function when sorting [latex]10^7[/latex] lists of varying sizes.</p>

<center>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/static/modules/gviz/1.0/chart.js"> {"dataSourceUrl":"//docs.google.com/a/rmarcus.info/spreadsheet/tq?key=0AmQWGSF3o-iidFlYX1lOWUtVNENMM0lCa05Tbi1VZUE&transpose=0&headers=1&range=A1%3AC24&gid=0&pub=1","options":{"vAxes":[{"useFormatFromData":true,"title":"Time (s)","minValue":null,"logScale":false,"viewWindow":{"min":null,"max":null},"maxValue":null},{"useFormatFromData":true,"minValue":null,"logScale":false,"viewWindow":{"min":null,"max":null},"maxValue":null}],"titleTextStyle":{"bold":true,"color":"#000","fontSize":16},"booleanRole":"certainty","curveType":"function","title":"10^7 Quicksort vs. Fallthrough Sort","animation":{"duration":500},"legend":"right","lineWidth":2,"useFirstColumnAsDomain":true,"hAxis":{"useFormatFromData":true,"title":"# of elements","minValue":null,"viewWindow":{"min":null,"max":null},"maxValue":null},"tooltip":{},"width":450,"height":320},"state":{},"view":{},"isDefaultVisualization":true,"chartType":"LineChart","chartName":"Chart 2"} </script>
</center>

<p>As the number of elements increases, fallthrough sort seems to slow down and approach the speed of qsort (eventually, qsort will become faster). This is expected, given the asymptotic behavior of each algorithm.</p>

<p>This last graph shows how many times faster fallthrough sort is compared to qsort.</p>

<center>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/static/modules/gviz/1.0/chart.js"> {"dataSourceUrl":"//docs.google.com/a/rmarcus.info/spreadsheet/tq?key=0AmQWGSF3o-iidFlYX1lOWUtVNENMM0lCa05Tbi1VZUE&transpose=0&headers=1&range=A26%3AB49&gid=0&pub=1","options":{"vAxes":[{"useFormatFromData":true,"title":"Times faster","minValue":null,"viewWindow":{"min":null,"max":null},"maxValue":null},{"useFormatFromData":true,"minValue":null,"viewWindow":{"min":null,"max":null},"maxValue":null}],"titleTextStyle":{"bold":true,"color":"#000","fontSize":16},"booleanRole":"certainty","curveType":"function","title":"Fallthrough Sort Speed Multiplier","animation":{"duration":500},"legend":"right","lineWidth":2,"useFirstColumnAsDomain":true,"hAxis":{"title":"# of elements","useFormatFromData":true,"minValue":null,"viewWindow":{"min":null,"max":null},"maxValue":null},"tooltip":{},"width":450,"height":320},"state":{},"view":{},"isDefaultVisualization":true,"chartType":"LineChart","chartName":"Chart 3"} </script>
</center>

<p>Here, the asymptotic behavior of both algorithms is extremely clear: qsort scales much better than fallthrough sort.</p>

<p>One might consider this comparison unfair because qsort evaluates a user-supplied comparison function. However, looking at the output of GCC reveals that when a very standard function (like the one above) is used, the comparison function is inlined.</p>

<p>One might also consider creating a <a href="http://en.wikipedia.org/wiki/Branch_table">branch table</a> to jump right to the required pass of bubble sort. Once again, looking at optimized GCC output will show that the above switch statement is optimized into a branch table.</p>

<p>You can view a sample implementation and benchmark code over at <a href="https://bitbucket.org/RyanMarcus/fallthrough-sort">BitBucket</a>.</p>

<p><a href="https://plus.google.com/u/0/108417296717615529338/posts/45VYfwK5mjU">Google+ comments</a>.</p>

<p><a href="http://www.reddit.com/r/programming/comments/1hilkn/fallthrough_sort_quickly_sorting_small_sets/">Reddit comments</a>.</p>

<p>Reddit user <a href="http://www.reddit.com/r/programming/comments/1hilkn/fallthrough_sort_quickly_sorting_small_sets/cauvhhp">sltkr seems to be getting better results from a simple insertion sort</a>. This appears to be due to CPU differences, but the discussion is ongoing.</p>


</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog/2014/06/03/connect4.html">
            A Connect 4 AI From the Ground Up
            <small>03 Jun 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2014/05/09/rdtheory.html">
            rdtheory.js: relational database algorithms in JavaScript
            <small>09 May 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2013/03/09/topntree.html">
            TopNTree: A merge-sort inspired data structure
            <small>09 Mar 2013</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
