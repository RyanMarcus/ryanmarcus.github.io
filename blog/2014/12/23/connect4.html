<!DOCTYPE html>
<html ng-app xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      A JavaScript Connect Four AI &middot; RMarcus
    
  </title>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    
    ga('create', 'UA-53336646-1', 'auto');
    ga('send', 'pageview');
    
  </script>
  
  <!-- CSS -->
  <link rel="stylesheet" href="/blog//public/css/poole.css">
  <link rel="stylesheet" href="/blog//public/css/syntax.css">
  <link rel="stylesheet" href="/blog//public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/blog//public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/blog//public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/blog//atom.xml">

  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    tex2jax: {
    inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']],
    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
    }
    });
  </script>
  <script type="text/javascript"
	  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>

  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.10/angular.min.js"></script>

</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/blog/">
          RMarcus
        </a>
      </h1>
      <p class="lead">The musings and work of Ryan Marcus, a graduate student at Brandeis University and the Los Alamos National Laboratory.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/blog/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/blog/pubs/">Portfolio</a>
          
        
      
        
      
        
      
        
          
        
      

            <a class="sidebar-nav-item" href="/blog"></a>

      <!-- <a class="sidebar-nav-item" href="/archive/v2.0.0.zip">Download</a>
      <a class="sidebar-nav-item" href="">GitHub project</a>
      <span class="sidebar-nav-item">Currently v2.0.0</span> -->
      <a class="sidebar-nav-item" href="http://twitter.com/RyanMarcus">Twitter</a>
    </nav>

    <p>&copy; 2014. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">A JavaScript Connect Four AI</h1>
  <span class="post-date">23 Dec 2014</span>
  <p>Might I interest you in a rousing game of <a href="http://en.wikipedia.org/wiki/Connect_Four">Connect Four</a>? You and the computer take turns dropping discs into one of the seven colums below. The goal is to get four pieces of your color in a row (vertically, diagonally, or horizontally).</p>

<script type="text/javascript" src="/blog/assets/conn4/conn4ctrl.js"></script>

<link rel="stylesheet" href="/blog/assets/conn4/conn4.css" />

<div class="conn4" ng-controller="ConnFourCtrl">
   <div class="info">
     <div>Winner: <span ng-hide="winner">none yet...</span><span ng-show="winner">Player {{winner}}</span></div>
     <div>Draw: <span ng-hide="draw">no</span><span ng-show="draw">yes</span></div>
   </div>
   <div class="thinking">
     <img src="/blog/assets/conn4/ajax-loader.gif" ng-show="thinking" />
   </div>
   
   <svg width="240" height="180">
     <rect width="100%" height="100%" style="fill: yellow;" />
     <g ng-repeat="row in board" transform="translate(30, {{ ($index + 1) * 25 }})">
       <circle ng-repeat="col in row track by $index" cx="{{ $index * 30 }}" cy="0" r="11" class="hlc" ng-show="isOver[$index]" />
       <circle ng-repeat="col in row track by $index" cx="{{ $index * 30 }}" cy="0" r="10" stroke="black" ng-class="col" ng-click="move($index)" ng-mouseover="over($index)" ng-mouseleave="leave($index)" />
     </g>
   </svg>
   
   
   <div class="ai">
     <form class="form-horizontal" role="form">
       <label for="movesAhead">Moves to to think ahead</label>
       <input type="integer" class="movesAhead" id="movesAhead" ng-model="look_ahead" />
     </form>
   </div>
   
 </div>

<p>That’s an <a href="https://angularjs.org">AngularJS</a> powered Connect Four AI that was originally written in C and then compiled to JavaScript using <a href="https://github.com/kripken/emscripten/wiki">Emscripten</a>. It runs the actual AI in a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/basic_usage">web worker</a> to prevent your browser from locking up.</p>

<p>It was implemented using techniques from <a href="http://www.cs.berkeley.edu/~russell/">Stuart Russell</a> and <a href="http://norvig.com">Peter Norvig’s</a> excellent book, <a href="http://www.amazon.com/Artificial-Intelligence-Modern-Approach-Edition/dp/0136042597">Artificial Intelligence: A Modern Approach (3rd Edition)</a>. These techniques might not create the best Connect Four AI possible (in fact, <a href="/blog/assets/conn4/thesis.pdf">Victor Allis’ thesis shows how to create a provably-unbeatable AI</a>), but it can still do pretty well! The code (in C, Python, and JavaScript) is available <a href="http://github.org/RyanMarcus/connect4">on GitHub</a>.</p>

<p>The main idea behind the AI is <a href="http://en.wikibooks.org/wiki/Artificial_Intelligence/Search/Adversarial_search/Minimax_Search">adversarial search</a>. Think of all the possible games of Connect Four represented as a tree. The root of the tree is the empty board. The second tier of the tree represents all the possible moves that can be made by the first player. The third tier of the tree represents all the possible moves that can be made by the second player.</p>

<p>A small subset of the tree (for a small game board) might look like this:</p>

<p><img src="/blog/assets/conn4/tree2.png" alt="Small tree" /></p>

<p>Imagine expanding the tree all the way down to the bottom, where the leaf nodes are “terminal” states – states where one player has won the game, or there is a draw. In order to make moves, the AI applies a <a href="http://en.wikipedia.org/wiki/Minimax">minimax strategy</a>. In other words, the AI assumes that its opponent will always play optimally, and thus tries to minimize the maximum gain of its opponent.</p>

<p>This tree is really big. The branching factor is approximately seven, and the depth of the tree could be as high as 42. So, while the the <a href="http://en.wikipedia.org/wiki/K-ary_tree">perfect tree formula</a> would tell us that there are <script type="math/tex">\frac{7^{43} - 1}{6} \approx 3 \mbox{ undecillion}</script> boards, some smart mathematicians have figured out that there are “only” around <a href="http://oeis.org/A212693">4 trillion different boards</a>. That’s still way too many to examine.</p>

<p>Thankfully, we can use a technique called <a href="http://en.wikipedia.org/wiki/Alpha–beta_pruning">alpha-beta pruning</a>. The idea is pretty simple: do not bother searching branches that would either:</p>

<ul>
  <li>require our opponent to make a detrimental move (to get an outcome less than the outcome they could get if they played optimally)</li>
  <li>or, require us to make a move that was less advantageous than another move we could make</li>
</ul>

<p>Now, this is a hand wavey oversimplification of how the process actually works. I suggest you read the chapters in Russell and Norvig, or fuss through the Wikipedia page, to get a better understanding. </p>

<p>In the average case, alpha-beta pruning reduces the number of nodes we need to evaluate from <script type="math/tex">O(b^d)</script> to <script type="math/tex">O(b^{\frac{3d}{4}})</script>. This brings us from 4 trillion boards to around 2.7 billion boards. A pretty good drop – but still not enough for us to enumerate.</p>

<p>Next, we employ a heuristic function. Since we can’t reach the bottom of the tree, we’ll go down a certain depth and then make some kind of guess as to whether or not the board we are evaluating is a winning or losing board. I used a very simple heuristic: the number of possible four-in-a-rows. The computer would calculate how many ways it could win using alignments present in the current board, and then subtract the number of ways the computer’s opponent could win.</p>

<p>Now, the computer will exhaustively evaluate the tree to a certain depth (the number of moves to “think ahead”) and then use a heuristic to evaluate that board. Eventually, as the end of the game draws near, the computer finds winning or losing states within the prescribed depth, and plays perfectly. The hope is that the heuristic function can guide the AI to a winnable position. It seems to work pretty well – if you can beat it, try increasing the number of moves to think ahead. It’ll make it slow down, but it’ll get exponentially more difficult. </p>

<p>Oh – there’s one more complication. A lot of the boards that you encounter when going down the tree are duplicates (there is more than one way to get to a state). To avoid recomputing the desirability of these boards, we store them in a hash table.</p>

<p>It also looks like writing this type of AI is homework for AI classes at <a href="http://www.cs.cornell.edu/courses/CS2110/2014sp/assignments/a4/A4ConnectFour.pdf">Cornell</a>,  <a href="http://www.ccs.neu.edu/home/eclip5e/classes/csu520/">Northeastern</a>, and <a href="https://www.cs.purdue.edu/homes/cs190m/fall08/projects/project4/">Purdue</a>. I could only find <a href="http://simulationcorner.net/index.php?page=connectfour">one other Javascript Connect Four AI</a>, which moves substantially faster than mine, but is easily defeated (which is exactly the behavior one would expect). </p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog//2014/10/05/dirty-json-parser.html">
            A Dirty JSON Parser
            <small>05 Oct 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog//2014/05/09/rdtheory.html">
            rdtheory.js: relational database algorithms in JavaScript
            <small>09 May 2014</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog//2013/07/01/fallthrough-sort.html">
            Fallthrough Sort: Quickly Sorting Small Sets
            <small>01 Jul 2013</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
